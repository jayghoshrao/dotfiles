#!/bin/python3

# depends on the mplstyle files from https://github.com/garrettj403/SciencePlots
# USAGE: ./plotChrom.py <file> <file> -o plot.pdf 

# TODO: add option to specify plots as files with only one column each, with x axis defined separately

import matplotlib as mpl
import matplotlib.pyplot as plt
from cycler import cycler
# import csv
import sys
import argparse
from subprocess import run
from pathlib import Path

def readCSV(data_path):
    time= []
    conc= []
    with open(data_path, newline='') as csvfile:
        # data = list(csv.reader(csvfile))
        for line in csvfile:
            data_line = line.strip().split(',')
            data_line = list(filter(None, data_line))
            if (data_line != []):
                time.append(float(data_line[0]))
                conc.append(float(data_line[1]))
    return time, conc

## MOve to h5plot
def readCadet(infile, unit, solution='outlet'):
    from cadet import Cadet
    from addict import Dict
    cadetpath = "/home/jayghoshter/local/bin/cadet-cli"
    Cadet.cadet_path = cadetpath
    sim = Cadet()
    sim.filename = infile
    sim.load()
    x = sim.root.output.solution.solution_times
    y = sim.root.output.solution['unit_' + "%03d" % unit]['solution_' + solution]
    return x, y

# def normalize(data):
#     return [ x/data[-1] for x in data ]

def normalize(data, refValue=None):
    if not refValue:
        print("No reference value for normalization provided: Using max point of curve.")
        refValue = max(data)
    return [ x/float(refValue) for x in data ]

def readArray(data_path):
    values =[]
    with open(data_path, newline='') as csvfile:
        for line in csvfile:
            values.append(float(line.strip()))
    return values

def readfile(data_path, columns):
    if ':' in data_path:
        run(['scp', '-rC', data_path, '/tmp/plotting.csv'])
        data_path = '/tmp/plotting.csv'

    x = []
    y = []
    xticksFromFile= None
    xticks = []
    # columns = [0, 1]
    delimiter = ' '
    with open(data_path, newline='') as csvfile:
        if ',' in csvfile.readline():
            delimiter = ','
    with open(data_path, newline='') as infile:
        # data = list(csv.reader(infile))
        for line in infile:
            data_line = line.strip().split(delimiter)
            data_line = list(filter(None, data_line))
            if (data_line != []):
                if len(data_line) == 1:
                    y.append(float(data_line[0]))
                else:
                    x.append(float(data_line[columns[0]]))
                    y.append(float(data_line[columns[1]]))
                # if columns[0] != -1:
                #     x.append(float(data_line[columns[0]]))
                # y.append(float(data_line[columns[1]]))
                if xticksFromFile:
                    xticks.append(float(data_line[columns[xticksFromFile]]))

    return x, y, xticks

def scale_axis(vec:list, scale_factor_or_file):
    if Path(scale_factor_or_file).expanduser().exists():
        scale_factors = readArray(scale_factor_or_file)
        vec = [ v*s for v,s in zip(vec, scale_factors)]
    else: 
        scale_factor = float(scale_factor_or_file)
        vec = [ v * scale_factor for v in vec ]
    return vec

ap = argparse.ArgumentParser()
ap.add_argument("files", nargs='*', help="files to plot")

ap.add_argument("-t", "--title", help="title")
ap.add_argument("-x", "--xlabel", help="xlabel")
ap.add_argument("-y", "--ylabel", help="ylabel")
ap.add_argument("-xl", "--xlims",nargs=2, type=float, help="x axis limits")
ap.add_argument("-yl", "--ylims",nargs=2, type=float, help="y axis limits")
ap.add_argument("-ls", "--linestyles", nargs='*', help="linestyles = solid dashed ...")
ap.add_argument("-lw", "--linewidths", nargs='*', help="linewidth = 0.1 2 ...")
ap.add_argument("-m", "--markers", nargs='*', help="markers = s, o, ...")
ap.add_argument("-n", "--normalize", action='store_true', help="normalize y data to the last value")
ap.add_argument("-l", "--labels", nargs='*', help="legend labels")
ap.add_argument("-c", "--columns", nargs='*', default = [0,1], type = int, help="columns to plot as x, y. (Partially implemented)")
ap.add_argument("-hg", "--histogram", type=int, help="histogram")
ap.add_argument("-s", "--separator", default=',', help="separator character")
ap.add_argument("-f", "--fill", action='store_true', help="fill area under curve")

ap.add_argument("-nl", "--no-legend", action='store_true', help="don't show legend")
ap.add_argument("--legend", nargs=3, default=['upper center', '0.5', '-0.2'], type=str, help="Legend settings: --legend <location> <bbox_to_anchor>")
ap.add_argument("--legend-frameon", action='store_true', help="Draw frame around legend")
ap.add_argument("--legend-size", default='medium', help="Legend font size:int or {'xx-small', 'x-small', 'small', 'medium', 'large', 'x-large', 'xx-large'}")
ap.add_argument("--legend-ncol", default=1, type=int, help="Number of columns in legend")

ap.add_argument("-xs", "--xscale", help="Scale the x axis for all plots by a numerical value or text file with every value")
ap.add_argument("-ys", "--yscale", help="Scale the y axis for all plots by a numerical value or text file with every value")

ap.add_argument("--xlog", action='store_true', help="X axis in log scale")
ap.add_argument("--ylog", action='store_true', help="Y axis in log scale")

ap.add_argument("--scatter", action='store_true', help="Show a scatter plot")

ap.add_argument("-o", "--output", help="output file")
ap.add_argument("-w", "--write", nargs='*', help="Write the CSV file (after applying rescaling if any)")
ap.add_argument("--split", action='store_true', help="Split the data into x and y.")

ap.add_argument("--cadet", nargs=2, help="Read h5 files. --cadet <unit_num> <solution_path>")


args = vars(ap.parse_args())

if not args['labels']:
    args['labels'] = args['files']

if not args['linestyles']:
    args['linestyles'] = [ 'solid' ] * len(args['files'])
    # args['linestyles'] = []
elif len(args['linestyles']) == 1:
    args['linestyles'] = args['linestyles'] * len(args['files'])

if not args['markers']:
    args['markers'] = [ None ] * len(args['files'])
    # args['markers'] = []
elif len(args['markers']) == 1:
    args['markers'] = args['markers'] * len(args['files'])

if not args['linewidths']:
    args['linewidths'] = [ 2 ] * len(args['files'])
    # args['linewidths'] = []
elif len(args['linewidths']) == 1:
    args['linewidths'] = args['linewidths'] * len(args['files'])


with plt.style.context(['science']):

    # plt.rcParams.update({
    #     "font.family": "serif",   # specify font family here
    #     "font.serif": ["Times"],  # specify font here
    #     "font.size":11})          # specify font size here

    ## A way to override the default style
    if args['legend_frameon']:
        plt.rcParams.update({
            "legend.shadow": True,
            "legend.frameon": True })

    fig, ax = plt.subplots()
    xs = []
    ys = []

    for filename,label,linestyle,marker,linewidth in zip(args['files'], args['labels'], args['linestyles'], args['markers'], args['linewidths']):
        if args['cadet']:
            x, y = readCadet(filename, int(args['cadet'][0]), args['cadet'][1])
            # print(x,y)
        else:
            x, y, xticks = readfile(filename, args['columns'])
        if args['normalize']:
            y = normalize(y)

        if args['xscale']:
            if x == []:
                x = [1] * len(y)
            x = scale_axis(x, args['xscale'])
        if args['yscale']:
            y = scale_axis(y, args['yscale'])

        xs.append(x)
        ys.append(y)

        if x != []:
            if args['scatter']:
                line = ax.scatter(x, y, label=label.replace('_', '-'))
            else:
                line = ax.plot(x, y, label=label.replace('_', '-'), marker=marker, linestyle=linestyle, linewidth=linewidth)
        else:
            if args['histogram']:
                line = ax.hist(y, bins=args['histogram'])
            else:
                line = ax.plot(y, label=label.replace('_', '-'), marker=marker, linestyle=linestyle, linewidth=linewidth)
        if args['fill']:
            ax.fill_between(x, y, 1, interpolate=True)

    if not args['no_legend']:
        legend = ax.legend(loc=args['legend'][0], bbox_to_anchor=(float(args['legend'][1]),float(args['legend'][2])), shadow=True, fontsize=args['legend_size'], ncol=args['legend_ncol'])

    ax.set(title=args['title'])
    ax.set(xlabel=args['xlabel'])
    ax.set(ylabel=args['ylabel'])

    if args['xlog']:
        ax.set(xscale="log")
    if args['ylog']:
        ax.set(yscale="log")

    ax.autoscale(tight=True)

    if args['xlims']:
        plt.xlim(args['xlims'])
    if args['ylims']:
        plt.ylim(args['ylims'])
    if args['output']:
        fig.savefig(args['output'], dpi=300)
    else:
        plt.show()

    if args['write']:
        import csv
        for filename,newname,x,y in zip(args['files'], args['write'], xs, ys):
            with open(newname, 'w') as f:
                writer = csv.writer(f, delimiter=',')
                writer.writerows(zip(x, y))

    if args['split']:
        import csv
        for filename,x,y in zip(args['files'], xs, ys):
            with open(filename + '.x', 'w') as f:
                writer = csv.writer(f, delimiter=',')
                writer.writerows(zip(x))
            with open(filename + '.y', 'w') as f:
                writer = csv.writer(f, delimiter=',')
                writer.writerows(zip(y))
