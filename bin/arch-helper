#!/usr/bin/env bash

# Script to help setup some stuff after a fresh install of Archlinux
#
# Usage: ./arch-post-install-helper.sh <command>
#
# Commands:
#   bootstrap-yay       Install yay AUR helper from scratch
#   bootstrap-paru      Install paru AUR helper from scratch
#   rebuild-yay         Quick rebuild of yay (after lib updates)
#   rebuild-paru        Quick rebuild of paru (after lib updates)
#   bootstrap-tpm       Install tmux plugin manager
#   install-nix         Install Nix package manager (custom root)
#   install-nix-official  Install Nix using official installer
#   nix-setup           Setup Nix channels and home-manager
#   set-environment     Set GTK/GNOME environment variables
#   install-packages    Install packages from package lists
#   save-packages       Save current packages to list files
#   update-mirrors      Update mirrorlist ranked by speed
#   clean-cache         Clear pacman cache (keep last 2 versions)
#   remove-orphans      Remove orphaned packages
#   check-pacnew        Find .pacnew/.pacsave config files
#   check-failed        Show failed systemd services
#   check-vulnerabilities  Check for known vulnerabilities
#   clean-journal       Vacuum systemd journal logs
#   clean-all           Run all cleanup tasks
#   diff-packages       Compare saved vs current packages
#   system-info         Show system health overview
#   help                Show this help message

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BASEDIR="$HOME"

# Package list files
PACKAGES_DIR="$HOME/local/share"
REPO_PACKAGES_FILE="${PACKAGES_DIR}/packages-repo.txt"
AUR_PACKAGES_FILE="${PACKAGES_DIR}/packages-aur.txt"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

confirm() {
    local prompt="${1:-Are you sure?}"
    read -rp "$prompt [y/N] " response
    [[ "$response" =~ ^[Yy]$ ]]
}

cleanup_temp() {
    local dir="$1"
    if [[ -d "$dir" ]]; then
        log_info "Cleaning up $dir"
        rm -rf "$dir"
    fi
}

# NOTE: Do this after package install. Ensure that theme is installed.
set_environment() {
    log_info "Setting GNOME/GTK environment variables in /etc/environment"

    sudo tee -a /etc/environment > /dev/null << 'EOFMARKER'

# Added by arch-post-install-helper
XDG_CURRENT_DESKTOP=GNOME
XDG_SESSION_DESKTOP=GNOME
XDG_SESSION_TYPE=x11
DESKTOP_SESSION=gnome
GNOME_DESKTOP_SESSION_ID=1
GTK_THEME=Qogir-Dark
EOFMARKER

    log_info "Environment variables added. Log out and back in for changes to take effect."
}

bootstrap_yay() {
    local tmp_dir="/tmp/bootstrap_yay_$$"
    trap 'cleanup_temp "$tmp_dir"' EXIT

    log_info "Installing yay AUR helper..."

    sudo pacman -S --needed git base-devel

    git clone https://aur.archlinux.org/yay.git "$tmp_dir"
    pushd "$tmp_dir" > /dev/null
    makepkg -si
    popd > /dev/null

    cleanup_temp "$tmp_dir"
    trap - EXIT

    log_info "Configuring yay for devel packages..."
    yay -Y --gendb
    yay -Syu --devel
    yay -Y --devel --save

    log_info "yay installed successfully!"
}

bootstrap_paru() {
    local tmp_dir="/tmp/bootstrap_paru_$$"
    trap 'cleanup_temp "$tmp_dir"' EXIT

    log_info "Installing paru AUR helper..."

    sudo pacman -S --needed git base-devel

    git clone https://aur.archlinux.org/paru.git "$tmp_dir"
    pushd "$tmp_dir" > /dev/null
    makepkg -si
    popd > /dev/null

    cleanup_temp "$tmp_dir"
    trap - EXIT

    log_info "paru installed successfully!"
}

# Quick rebuild for when AUR helpers break after library updates
rebuild_yay() {
    log_info "Rebuilding yay (useful after library updates)..."

    if command -v yay &> /dev/null; then
        yay -S --rebuild yay-bin
    else
        log_warn "yay not found, attempting full bootstrap..."
        bootstrap_yay
    fi
}

rebuild_paru() {
    log_info "Rebuilding paru (useful after library updates)..."

    if command -v paru &> /dev/null; then
        paru -S --rebuild paru-bin
    else
        log_warn "paru not found, attempting full bootstrap..."
        bootstrap_paru
    fi
}

bootstrap_tpm() {
    local tpm_dir="$HOME/.tmux/plugins/tpm"

    if [[ -d "$tpm_dir" ]]; then
        log_warn "TPM already installed at $tpm_dir"
        if confirm "Remove and reinstall?"; then
            rm -rf "$tpm_dir"
        else
            return 0
        fi
    fi

    log_info "Installing tmux plugin manager..."
    git clone https://github.com/tmux-plugins/tpm "$tpm_dir"
    log_info "TPM installed. Press prefix + I in tmux to install plugins."
}

install_nix() {
    local nix_root="$HOME/local/nix"

    log_warn "This installs Nix with a custom root at $nix_root"
    log_warn "Consider using 'install-nix-official' for the standard installation."

    if ! confirm "Continue with custom Nix installation?"; then
        return 0
    fi

    mkdir -p "$nix_root"
    sudo mkdir -p /nix
    sudo mount --bind "$nix_root" /nix

    log_warn "Add the following to /etc/fstab for persistence:"
    echo "  $nix_root /nix none bind 0 0"

    sudo pacman -S nix

    sudo systemctl enable nix-daemon.service
    sudo systemctl start nix-daemon.service
    sudo usermod -aG nix-users "$(whoami)"

    log_info "Nix installed. A reboot is required."
    if confirm "Reboot now?"; then
        reboot
    else
        log_warn "Remember to reboot before using Nix!"
    fi
}

install_nix_official() {
    log_info "Installing Nix using the official installer..."
    log_info "This will use the standard /nix location with daemon mode."

    if ! confirm "Continue?"; then
        return 0
    fi

    sh <(curl -L https://nixos.org/nix/install) --daemon

    log_info "Nix installed. Follow the on-screen instructions to complete setup."
}

nix_setup() {
    if ! command -v nix-channel &> /dev/null; then
        log_error "Nix is not installed or not in PATH. Run 'install-nix' first."
        return 1
    fi

    log_info "Setting up Nix channels..."
    nix-channel --add https://nixos.org/channels/nixpkgs-unstable
    nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
    nix-channel --update

    log_info "Installing home-manager..."
    nix-shell '<home-manager>' -A install

    log_info "Adding home-manager session vars to ~/.profile"
    echo 'source "$HOME/.nix-profile/etc/profile.d/hm-session-vars.sh"' >> "$HOME/.profile"

    log_info "Nix setup complete!"
}

install_packages() {
    log_info "Installing packages from lists..."

    # Install repo packages
    if [[ -f "$REPO_PACKAGES_FILE" ]]; then
        log_info "Installing packages from $REPO_PACKAGES_FILE"
        # Filter out comments and empty lines
        grep -v '^#' "$REPO_PACKAGES_FILE" | grep -v '^$' | sudo pacman -S --needed -
    else
        log_warn "Repo packages file not found: $REPO_PACKAGES_FILE"
        log_info "Create it with one package name per line."
    fi

    # Install AUR packages
    if [[ -f "$AUR_PACKAGES_FILE" ]]; then
        local aur_helper=""
        if command -v paru &> /dev/null; then
            aur_helper="paru"
        elif command -v yay &> /dev/null; then
            aur_helper="yay"
        else
            log_error "No AUR helper found. Run 'bootstrap-paru' or 'bootstrap-yay' first."
            return 1
        fi

        log_info "Installing AUR packages from $AUR_PACKAGES_FILE using $aur_helper"
        grep -v '^#' "$AUR_PACKAGES_FILE" | grep -v '^$' | $aur_helper -S --needed -
    else
        log_warn "AUR packages file not found: $AUR_PACKAGES_FILE"
        log_info "Create it with one package name per line."
    fi
}

save_packages() {
    local timestamp
    timestamp="$(date '+%Y-%m-%d %H:%M:%S')"

    log_info "Saving explicitly installed packages..."

    # Ensure directory exists
    mkdir -p "$PACKAGES_DIR"

    # Save repo packages (native, explicitly installed)
    {
        echo "# Arch Linux official repository packages"
        echo "# Generated: $timestamp"
        echo "# Restore with: pacman -S --needed - < packages-repo.txt"
        echo ""
        pacman -Qqen
    } > "$REPO_PACKAGES_FILE"

    local repo_count
    repo_count=$(pacman -Qqen | wc -l)
    log_info "Saved $repo_count repo packages to $REPO_PACKAGES_FILE"

    # Save AUR/foreign packages (explicitly installed)
    {
        echo "# AUR / foreign packages"
        echo "# Generated: $timestamp"
        echo "# Restore with: paru -S --needed - < packages-aur.txt"
        echo ""
        pacman -Qqem
    } > "$AUR_PACKAGES_FILE"

    local aur_count
    aur_count=$(pacman -Qqem | wc -l)
    log_info "Saved $aur_count AUR/foreign packages to $AUR_PACKAGES_FILE"

    log_info "Done! Package lists saved."
}

update_mirrors() {
    local mirrorlist="/etc/pacman.d/mirrorlist"
    local backup="${mirrorlist}.backup.$(date '+%Y%m%d%H%M%S')"
    local country="${1:-}"

    # Check if reflector is installed
    if ! command -v reflector &> /dev/null; then
        log_info "Installing reflector..."
        sudo pacman -S --needed reflector
    fi

    log_info "Backing up current mirrorlist to $backup"
    sudo cp "$mirrorlist" "$backup"

    log_info "Fetching and ranking mirrors by speed..."
    log_info "This may take a few minutes..."

    local reflector_args=(
        --latest 20
        --protocol https
        --sort rate
        --save "$mirrorlist"
    )

    # Add country filter if specified
    if [[ -n "$country" ]]; then
        log_info "Filtering mirrors for country: $country"
        reflector_args+=(--country "$country")
    fi

    sudo reflector "${reflector_args[@]}"

    log_info "Mirrorlist updated! Top mirrors:"
    head -10 "$mirrorlist" | grep -v '^#' | head -5
}

clean_cache() {
    # Check if paccache is available (from pacman-contrib)
    if ! command -v paccache &> /dev/null; then
        log_info "Installing pacman-contrib for paccache..."
        sudo pacman -S --needed pacman-contrib
    fi

    log_info "Current cache size:"
    du -sh /var/cache/pacman/pkg/ 2>/dev/null || echo "  Unable to determine"

    log_info "Removing old package versions (keeping last 2)..."
    sudo paccache -r -k 2

    log_info "Removing all cached versions of uninstalled packages..."
    sudo paccache -ruk0

    log_info "New cache size:"
    du -sh /var/cache/pacman/pkg/ 2>/dev/null || echo "  Unable to determine"
}

remove_orphans() {
    local orphans
    orphans=$(pacman -Qdtq 2>/dev/null || true)

    if [[ -z "$orphans" ]]; then
        log_info "No orphaned packages found."
        return 0
    fi

    log_info "Found orphaned packages:"
    echo "$orphans" | while read -r pkg; do
        echo "  - $pkg"
    done

    if confirm "Remove these orphaned packages?"; then
        echo "$orphans" | sudo pacman -Rns -
        log_info "Orphaned packages removed."
    else
        log_info "Skipped orphan removal."
    fi
}

check_pacnew() {
    log_info "Searching for .pacnew and .pacsave files..."

    local pacnew_files
    pacnew_files=$(sudo find /etc -name "*.pacnew" -o -name "*.pacsave" 2>/dev/null || true)

    if [[ -z "$pacnew_files" ]]; then
        log_info "No .pacnew or .pacsave files found."
        return 0
    fi

    log_warn "Found configuration files that need attention:"
    echo "$pacnew_files" | while read -r file; do
        echo "  $file"
    done

    echo ""
    log_info "To compare files, use:"
    echo "  diff -u /etc/somefile /etc/somefile.pacnew"
    log_info "To merge interactively, consider installing 'pacdiff' (pacman-contrib) or 'meld'"
}

check_failed() {
    log_info "Checking for failed systemd services..."

    local failed
    failed=$(systemctl --failed --no-legend 2>/dev/null || true)

    if [[ -z "$failed" ]]; then
        log_info "No failed services found."
        return 0
    fi

    log_error "Failed services detected:"
    systemctl --failed

    echo ""
    log_info "To investigate a failed service:"
    echo "  journalctl -xeu <service-name>"
}

check_vulnerabilities() {
    if ! command -v arch-audit &> /dev/null; then
        log_info "Installing arch-audit..."
        sudo pacman -S --needed arch-audit
    fi

    log_info "Checking for known vulnerabilities..."

    local vuln_output
    vuln_output=$(arch-audit 2>/dev/null || true)

    if [[ -z "$vuln_output" ]]; then
        log_info "No known vulnerabilities found in installed packages."
    else
        log_warn "Vulnerable packages found:"
        arch-audit
    fi
}

clean_journal() {
    log_info "Current journal size:"
    journalctl --disk-usage

    log_info "Vacuuming journal logs (keeping last 2 weeks)..."
    sudo journalctl --vacuum-time=2weeks

    log_info "New journal size:"
    journalctl --disk-usage
}

clean_all() {
    log_info "Running all cleanup tasks..."
    echo ""

    log_info "=== Cleaning package cache ==="
    clean_cache
    echo ""

    log_info "=== Removing orphaned packages ==="
    remove_orphans
    echo ""

    log_info "=== Cleaning journal logs ==="
    clean_journal
    echo ""

    log_info "All cleanup tasks completed!"
}

diff_packages() {
    if [[ ! -f "$REPO_PACKAGES_FILE" ]]; then
        log_error "Saved repo packages file not found: $REPO_PACKAGES_FILE"
        log_info "Run 'save-packages' first to create a baseline."
        return 1
    fi

    local current_repo current_aur
    current_repo=$(mktemp)
    current_aur=$(mktemp)
    trap 'rm -f "$current_repo" "$current_aur"' RETURN

    # Get current packages
    pacman -Qqen > "$current_repo"
    pacman -Qqem > "$current_aur"

    # Get saved packages (filter out comments and empty lines)
    local saved_repo saved_aur
    saved_repo=$(mktemp)
    saved_aur=$(mktemp)
    trap 'rm -f "$current_repo" "$current_aur" "$saved_repo" "$saved_aur"' RETURN

    grep -v '^#' "$REPO_PACKAGES_FILE" | grep -v '^$' | sort > "$saved_repo"
    sort "$current_repo" -o "$current_repo"

    echo "=== Repository Packages ==="
    echo ""

    local added removed
    added=$(comm -13 "$saved_repo" "$current_repo")
    removed=$(comm -23 "$saved_repo" "$current_repo")

    if [[ -n "$added" ]]; then
        log_info "Packages added since last save:"
        echo "$added" | while read -r pkg; do echo "  + $pkg"; done
    else
        log_info "No new repo packages added."
    fi

    echo ""

    if [[ -n "$removed" ]]; then
        log_warn "Packages removed since last save:"
        echo "$removed" | while read -r pkg; do echo "  - $pkg"; done
    else
        log_info "No repo packages removed."
    fi

    echo ""
    echo "=== AUR Packages ==="
    echo ""

    if [[ -f "$AUR_PACKAGES_FILE" ]]; then
        grep -v '^#' "$AUR_PACKAGES_FILE" | grep -v '^$' | sort > "$saved_aur"
        sort "$current_aur" -o "$current_aur"

        added=$(comm -13 "$saved_aur" "$current_aur")
        removed=$(comm -23 "$saved_aur" "$current_aur")

        if [[ -n "$added" ]]; then
            log_info "AUR packages added since last save:"
            echo "$added" | while read -r pkg; do echo "  + $pkg"; done
        else
            log_info "No new AUR packages added."
        fi

        echo ""

        if [[ -n "$removed" ]]; then
            log_warn "AUR packages removed since last save:"
            echo "$removed" | while read -r pkg; do echo "  - $pkg"; done
        else
            log_info "No AUR packages removed."
        fi
    else
        log_warn "No saved AUR packages file found."
    fi
}

system_info() {
    echo "=== System Health Overview ==="
    echo ""

    # Kernel and uptime
    log_info "System:"
    echo "  Kernel: $(uname -r)"
    echo "  Uptime: $(uptime -p)"
    echo ""

    # Disk usage
    log_info "Disk Usage:"
    df -h / /home 2>/dev/null | tail -n +2 | while read -r line; do
        echo "  $line"
    done
    echo ""

    # Memory
    log_info "Memory:"
    free -h | grep -E "^Mem:" | awk '{print "  Used: " $3 " / " $2 " (" int($3/$2*100) "%)"}'
    echo ""

    # Package cache size
    log_info "Package Cache:"
    echo "  $(du -sh /var/cache/pacman/pkg/ 2>/dev/null | cut -f1)"
    echo ""

    # Journal size
    log_info "Journal Size:"
    echo "  $(journalctl --disk-usage 2>/dev/null | grep -oP 'archived and active journals.*' || echo 'Unable to determine')"
    echo ""

    # Orphaned packages
    local orphan_count
    orphan_count=$(pacman -Qdtq 2>/dev/null | wc -l || echo "0")
    if [[ "$orphan_count" -gt 0 ]]; then
        log_warn "Orphaned Packages: $orphan_count"
    else
        log_info "Orphaned Packages: 0"
    fi
    echo ""

    # Failed services
    local failed_count
    failed_count=$(systemctl --failed --no-legend 2>/dev/null | wc -l || echo "0")
    if [[ "$failed_count" -gt 0 ]]; then
        log_error "Failed Services: $failed_count"
        systemctl --failed --no-legend 2>/dev/null | while read -r line; do
            echo "  $line"
        done
    else
        log_info "Failed Services: 0"
    fi
    echo ""

    # Pacnew files
    local pacnew_count
    pacnew_count=$(sudo find /etc -name "*.pacnew" -o -name "*.pacsave" 2>/dev/null | wc -l || echo "0")
    if [[ "$pacnew_count" -gt 0 ]]; then
        log_warn "Pacnew/Pacsave Files: $pacnew_count"
    else
        log_info "Pacnew/Pacsave Files: 0"
    fi
    echo ""

    # Updates available
    log_info "Checking for updates..."
    local update_count
    update_count=$(checkupdates 2>/dev/null | wc -l || echo "?")
    if [[ "$update_count" == "?" ]]; then
        echo "  Unable to check (install pacman-contrib for checkupdates)"
    elif [[ "$update_count" -gt 0 ]]; then
        log_warn "Updates Available: $update_count"
    else
        log_info "Updates Available: 0"
    fi
}

show_help() {
    head -n 29 "${BASH_SOURCE[0]}" | tail -n 27
}

main() {
    local command="${1:-help}"

    case "$command" in
        bootstrap-yay)
            bootstrap_yay
            ;;
        bootstrap-paru)
            bootstrap_paru
            ;;
        rebuild-yay)
            rebuild_yay
            ;;
        rebuild-paru)
            rebuild_paru
            ;;
        bootstrap-tpm)
            bootstrap_tpm
            ;;
        install-nix)
            install_nix
            ;;
        install-nix-official)
            install_nix_official
            ;;
        nix-setup)
            nix_setup
            ;;
        set-environment)
            set_environment
            ;;
        install-packages)
            install_packages
            ;;
        save-packages)
            save_packages
            ;;
        update-mirrors)
            update_mirrors "${2:-}"
            ;;
        clean-cache)
            clean_cache
            ;;
        remove-orphans)
            remove_orphans
            ;;
        check-pacnew)
            check_pacnew
            ;;
        check-failed)
            check_failed
            ;;
        check-vulnerabilities)
            check_vulnerabilities
            ;;
        clean-journal)
            clean_journal
            ;;
        clean-all)
            clean_all
            ;;
        diff-packages)
            diff_packages
            ;;
        system-info)
            system_info
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log_error "Unknown command: $command"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
